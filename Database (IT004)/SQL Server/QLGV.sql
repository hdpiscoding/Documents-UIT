CREATE DATABASE QLGV

--CREATE TABLE 
CREATE TABLE KHOA
(
	MAKHOA varchar(4),
	TENKHOA varchar(40),
	NGTLAP datetime,
	TRGKHOA char(4)
)

CREATE TABLE MONHOC
(
	MAMH varchar(10),
	TENMH varchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA	varchar(4)
)

CREATE TABLE DIEUKIEN
(
	MAMH varchar(10),
	MAMH_TRUOC varchar(10)
)

CREATE TABLE GIAOVIEN 
( 
	MAGV char(4),
	HOTEN varchar(40),
	HOCVI varchar(10),
	HOCHAM varchar(10),
	GIOITINH varchar(3),
	NGSINH datetime,
	NGVL datetime,
	HESO numeric(4,2),
	MUCLUONG money,
	MAKHOA varchar(4)
)

CREATE TABLE LOP
(	
	MALOP char(3),
	TENLOP varchar(40),
	TRGLOP char(5),
	SISO tinyint,
	MAGVCN char(4)
)

CREATE TABLE HOCVIEN 
(	
	MAHV char(5),
	HO varchar(40),
	TEN varchar(10),
	NGSINH datetime,
	GIOITINH varchar(3),
	NOISINH varchar(40),
	MALOP char(3)
)

CREATE TABLE GIANGDAY
(
	MALOP char(3),
	MAMH varchar(10),
	MAGV char(4),
	HOCKY tinyint,
	NAM smallint,
	TUNGAY datetime,
	DENNGAY datetime
)

CREATE TABLE KETQUATHI
(
	MAHV char(5),
	MAMH varchar(10),
	LANTHI tinyint,
	NGTHI datetime,
	DIEM numeric(4,2),
	KQUA varchar(10)
)

--DEFINE NOT NULL
ALTER TABLE KHOA 
ALTER COLUMN MAKHOA
varchar(4) NOT NULL

ALTER TABLE MONHOC
ALTER COLUMN MAMH
varchar(10) NOT NULL

ALTER TABLE DIEUKIEN
ALTER COLUMN MAMH 
varchar(10) NOT NULL 

ALTER TABLE DIEUKIEN
ALTER COLUMN MAMH_TRUOC 
varchar(10) NOT NULL

ALTER TABLE GIAOVIEN 
ALTER COLUMN MAGV
char(4) NOT NULL

ALTER TABLE LOP
ALTER COLUMN MALOP
char(3) NOT NULL

ALTER TABLE HOCVIEN 
ALTER COLUMN MAHV
char(5) NOT NULL

ALTER TABLE GIANGDAY
ALTER COLUMN MALOP
char(3) NOT NULL

ALTER TABLE GIANGDAY
ALTER COLUMN MAMH
varchar(10) NOT NULL

ALTER TABLE KETQUATHI
ALTER COLUMN MAHV
char(5) NOT NULL

ALTER TABLE KETQUATHI
ALTER COLUMN MAMH
varchar(10) NOT NULL

ALTER TABLE KETQUATHI
ALTER COLUMN LANTHI
tinyint NOT NULL

--ADD PRIMARY KEY
ALTER TABLE KHOA
ADD CONSTRAINT PK_KHOA PRIMARY KEY (MAKHOA)

ALTER TABLE MONHOC
ADD CONSTRAINT PK_MH PRIMARY KEY (MAMH)

ALTER TABLE DIEUKIEN 
ADD CONSTRAINT PK_DK PRIMARY KEY (MAMH, MAMH_TRUOC)

ALTER TABLE GIAOVIEN 
ADD CONSTRAINT PK_GV PRIMARY KEY (MAGV)

ALTER TABLE LOP
ADD CONSTRAINT PK_LOP PRIMARY KEY (MALOP)

ALTER TABLE HOCVIEN 
ADD CONSTRAINT PK_HV PRIMARY KEY (MAHV)

ALTER TABLE GIANGDAY
ADD CONSTRAINT PK_GD PRIMARY KEY (MALOP, MAMH)

ALTER TABLE KETQUATHI
ADD CONSTRAINT PK_KQ PRIMARY KEY (MAHV, MAMH, LANTHI)

--ADD FOREIGN KEY
ALTER TABLE KHOA 
ADD CONSTRAINT FK_KHOA_GV FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE MONHOC 
ADD CONSTRAINT FK_MH_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE DIEUKIEN ADD
CONSTRAINT FK_DK_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
CONSTRAINT FK_DK_MH_TRUOC FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)

ALTER TABLE LOP ADD
CONSTRAINT FK_LOP_HV FOREIGN KEY (TRGLOP) REFERENCES HOCVIEN(MAHV),
CONSTRAINT FK_LOP_GV FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE HOCVIEN
ADD CONSTRAINT FK_HV_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE GIANGDAY ADD
CONSTRAINT FK_GD_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP),
CONSTRAINT FK_GD_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
CONSTRAINT FK_GD_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE KETQUATHI ADD
CONSTRAINT FK_KQ_HV FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV),
CONSTRAINT FK_KQ_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE GIAOVIEN
DROP CONSTRAINT FK_KHOA_GV

--IMPORT DATA
INSERT INTO KHOA(MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES
('KHMT','Khoa hoc may tinh','2005/06/07','GV01'),
('HTTT','He thong thong tin','2005/06/07','GV02'),
('CNPM','Cong nghe phan mem','2005/06/07','GV04'),
('MMT','Mang may tinh','2005/10/20','GV03'),
('KTMT','Ky thuat may tinh','2005/12/20',NULL)

INSERT INTO LOP(MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES
('K11','Lop 1 khoa 1','K1108','11','GV07'),
('K12','Lop 2 khoa 1','K1205','12','GV09'),
('K13','Lop 3 khoa 1','K1305','12','GV14')

INSERT INTO GIAOVIEN (MAGV, HOTEN, HOCVI, HOCHAM, GIOITINH, NGSINH, NGVL, HESO, MUCLUONG, MAKHOA) VALUES
('GV01', 'Ho Thanh Son', 'PTS', 'GS', 'Nam', '1950-05-02', '2004-01-11', 5.00, 2250000, 'KHMT'),
('GV02', 'Tran Tam Thanh', 'TS', 'PGS', 'Nam', '1965-12-17', '2004-04-20', 4.50, 2025000, 'HTTT'),
('GV03', 'Do Nghiem Phung', 'TS', 'GS', 'Nu', '1950-08-01', '2004-09-23', 4.00, 1800000, 'CNPM'),
('GV04', 'Tran Nam Son', 'TS', 'PGS', 'Nam', '1961-02-22', '2005-01-12', 4.50, 2025000, 'KTMT'),
('GV05', 'Mai Thanh Danh', 'ThS', 'GV', 'Nam', '1958-03-12', '2005-01-12', 3.00, 1350000, 'HTTT'),
('GV06', 'Tran Doan Hung', 'TS', 'GV', 'Nam', '1953-03-11', '2005-01-12', 4.50, 2025000, 'KHMT'),
('GV07', 'Nguyen Minh Tien', 'ThS', 'GV', 'Nam', '1971-11-23', '2005-03-01', 4.00, 1800000, 'KHMT'),
('GV08', 'Le Thi Tran', 'KS', NULL, 'Nu', '1974-03-26', '2005-03-01', 1.69, 760500, 'KHMT'),
('GV09', 'Nguyen To Lan', 'ThS', 'GV', 'Nu', '1966-12-31', '2005-03-01', 4.00, 1800000, 'HTTT'),
('GV10', 'Le Tran Anh Loan', 'KS', NULL, 'Nu', '1972-07-17', '2005-03-01', 1.86, 837000, 'CNPM'),
('GV11', 'Ho Thanh Tung', 'CN', 'GV', 'Nam', '1980-01-12', '2005-05-15', 2.67, 1201500, 'MTT'),
('GV12', 'Tran Van Anh', 'CN', NULL, 'Nu', '1981-03-29', '2005-05-15', 1.69, 760500, 'CNPM'),
('GV13', 'Nguyen Linh Dan', 'CN', NULL, 'Nu', '1980-05-23', '2005-05-15', 1.69, 760500, 'KTMT'),
('GV14', 'Truong Minh Chau', 'ThS', 'GV', 'Nu', '1976-11-30', '2005-05-15', 3.00, 1350000, 'MTT'),
('GV15', 'Le Ha Thanh', 'ThS', 'GV', 'Nam', '1978-05-04', '2005-05-15', 3.00, 1350000, 'KHMT');

INSERT INTO GIANGDAY (MALOP, MAMH, MAGV, HOCKY, NAM, TUNGAY, DENNGAY) VALUES
('K11', 'THDC', 'GV07', 1, 2006, '2006-01-02', '2006-05-12'),
('K12', 'THDC', 'GV06', 1, 2006, '2006-01-02', '2006-05-12'),
('K13', 'THDC', 'GV15', 1, 2006, '2006-01-02', '2006-05-12'),
('K11', 'CTRR', 'GV02', 1, 2006, '2006-01-09', '2006-05-17'),
('K12', 'CTRR', 'GV02', 1, 2006, '2006-01-09', '2006-05-17'),
('K13', 'CTRR', 'GV08', 1, 2006, '2006-01-09', '2006-05-17'),
('K11', 'CSDL', 'GV05', 2, 2006, '2006-06-01', '2006-07-15'),
('K12', 'CSDL', 'GV09', 2, 2006, '2006-06-01', '2006-07-15'),
('K13', 'CTDLGT', 'GV15', 2, 2006, '2006-06-01', '2006-07-15'),
('K13', 'CSDL', 'GV05', 3, 2006, '2006-08-01', '2006-12-15'),
('K13', 'DHMT', 'GV07', 3, 2006, '2006-08-01', '2006-12-15'),
('K11', 'CTDLGT', 'GV15', 3, 2006, '2006-08-01', '2006-12-15'),
('K12', 'CTDLGT', 'GV15', 3, 2006, '2006-08-01', '2006-12-15'),
('K11', 'HDH', 'GV04', 1, 2007, '2007-01-02', '2007-02-18'),
('K12', 'HDH', 'GV04', 1, 2007, '2007-01-02', '2007-03-20'),
('K11', 'DHMT', 'GV07', 1, 2007, '2007-02-18', '2007-03-20');

INSERT INTO HOCVIEN (MAHV, HO, TEN, NGSINH, GIOITINH, NOISINH, MALOP) VALUES
('K1101', 'Nguyen Van', 'A', '1986-01-27', 'Nam', 'TpHCM', 'K11'),
('K1102', 'Tran Ngoc', 'Han', '1986-03-14', 'Nu', 'Kien Giang', 'K11'),
('K1103', 'Ha Duy', 'Lap', '1986-04-18', 'Nam', 'Nghe An', 'K11'),
('K1104', 'Tran Ngoc', 'Linh', '1986-03-30', 'Nu', 'Tay Ninh', 'K11'),
('K1105', 'Tran Minh', 'Long', '1986-02-27', 'Nam', 'TpHCM', 'K11'),
('K1106', 'Le Nhat', 'Minh', '1986-01-24', 'Nam', 'TpHCM', 'K11'),
('K1107', 'Nguyen Nhu', 'Nhut', '1986-01-27', 'Nam', 'Ha Noi', 'K11'),
('K1108', 'Nguyen Manh', 'Tam', '1986-02-27', 'Nam', 'Kien Giang', 'K11'),
('K1109', 'Phan Thi Thanh', 'Tam', '1986-01-27', 'Nu', 'Vinh Long', 'K11'),
('K1110', 'Le Hoai', 'Thuong', '1986-02-05', 'Nu', 'Can Tho', 'K11'),
('K1111', 'Le Ha', 'Vinh', '1986-12-25', 'Nam', 'Vinh Long', 'K11'),
('K1201', 'Nguyen Van', 'B', '1986-02-11', 'Nam', 'TpHCM', 'K12'),
('K1202', 'Nguyen Thi Kim', 'Duyen', '1986-01-18', 'Nu', 'TpHCM', 'K12'),
('K1203', 'Tran Thi Kim', 'Duyen', '1986-09-17', 'Nu', 'TpHCM', 'K12'),
('K1204', 'Truong My', 'Hanh', '1986-05-19', 'Nu', 'Dong Nai', 'K12'),
('K1205', 'Nguyen Thanh', 'Nam', '1986-04-17', 'Nam', 'TpHCM', 'K12'),
('K1206', 'Nguyen Thi Truc', 'Thanh', '1986-03-04', 'Nu', 'Kien Giang', 'K12'),
('K1207', 'Tran Thi Bich', 'Thuy', '1986-02-08', 'Nu', 'Nghe An', 'K12'),
('K1208', 'Huynh Thi Kim', 'Trieu', '1986-04-08', 'Nu', 'Tay Ninh', 'K12'),
('K1209', 'Pham Thanh', 'Trieu', '1986-02-23', 'Nam', 'TpHCM', 'K12'),
('K1210', 'Ngo Thanh', 'Tuan', '1986-02-14', 'Nam', 'TpHCM', 'K12'),
('K1211', 'Do Thi', 'Xuan', '1986-03-09', 'Nu', 'Ha Noi', 'K12'),
('K1212', 'Le Thi Phi', 'Yen', '1986-03-12', 'Nu', 'TpHCM', 'K12'),
('K1301', 'Nguyen Thi Kim', 'Cuc', '1986-06-09', 'Nu', 'Kien Giang', 'K13'),
('K1302', 'Truong Thi My', 'Hien', '1986-03-18', 'Nu', 'Nghe An', 'K13'),
('K1303', 'Le Duc', 'Hien', '1986-03-21', 'Nam', 'Tay Ninh', 'K13'),
('K1304', 'Le Quang', 'Hien', '1986-04-18', 'Nam', 'TpHCM', 'K13'),
('K1305', 'Le Thi', 'Huong', '1986-03-27', 'Nu', 'TpHCM', 'K13'),
('K1306', 'Nguyen Thai', 'Huu', '1986-03-30', 'Nam', 'Ha Noi', 'K13'),
('K1307', 'Tran Minh', 'Man', '1986-05-28', 'Nam', 'TpHCM', 'K13'),
('K1308', 'Nguyen Hieu', 'Nghia', '1986-04-08', 'Nam', 'Kien Giang', 'K13'),
('K1309', 'Nguyen Trung', 'Nghia', '1987-01-18', 'Nam', 'Nghe An', 'K13'),
('K1310', 'Tran Thi Hong', 'Tham', '1986-04-22', 'Nu', 'Tay Ninh', 'K13'),
('K1311', 'Tran Minh', 'Thuc', '1986-04-04', 'Nam', 'TpHCM', 'K13'),
('K1312', 'Nguyen Thi Kim', 'Yen', '1986-09-07', 'Nu', 'TpHCM', 'K13');

INSERT INTO KETQUATHI (MAHV, MAMH, LANTHI, NGTHI, DIEM, KQUA) VALUES
('K1101', 'CSDL', 1, '2006-07-20', 10.00, 'Dat'),
('K1101', 'CTDLGT', 1, '2006-12-28', 9.00, 'Dat'),
('K1101', 'THDC', 1, '2006-05-20', 9.00, 'Dat'),
('K1101', 'CTRR', 1, '2006-05-13', 9.50, 'Dat'),
('K1102', 'CSDL', 1, '2006-07-20', 4.00, 'Khong Dat'),
('K1102', 'CSDL', 2, '2006-07-27', 4.25, 'Khong Dat'),
('K1102', 'CSDL', 3, '2006-08-10', 4.50, 'Khong Dat'),
('K1102', 'CTDLGT', 1, '2006-12-28', 4.50, 'Khong Dat'),
('K1102', 'CTDLGT', 2, '2007-01-05', 4.00, 'Khong Dat'),
('K1102', 'CTDLGT', 3, '2007-01-15', 6.00, 'Dat'),
('K1102', 'THDC', 1, '2006-05-20', 5.00, 'Dat'),
('K1102', 'CTRR', 1, '2006-05-13', 7.00, 'Dat'),
('K1103', 'CSDL', 1, '2006-07-20', 3.50, 'Khong Dat'),
('K1103', 'CSDL', 2, '2006-07-27', 8.25, 'Dat'),
('K1103', 'CTDLGT', 1, '2006-12-28', 7.00, 'Dat'),
('K1103', 'THDC', 1, '2006-05-20', 8.00, 'Dat'),
('K1103', 'CTRR', 1, '2006-05-13', 6.50, 'Dat'),
('K1104', 'CSDL', 1, '2006-07-20', 3.75, 'Khong Dat'),
('K1104', 'CTDLGT', 1, '2006-12-28', 4.00, 'Khong Dat'),
('K1104', 'THDC', 1, '2006-05-20', 4.00, 'Khong Dat'),
('K1104', 'CTRR', 1, '2006-05-13', 4.00, 'Khong Dat'),
('K1104', 'CTRR', 2, '2006-05-20', 3.50, 'Khong Dat'),
('K1104', 'CTRR', 3, '2006-06-30', 4.00, 'Khong Dat'),
('K1201', 'CSDL', 1, '2006-07-20', 6.00, 'Dat'),
('K1201', 'CTDLGT', 1, '2006-12-28', 5.00, 'Dat'),
('K1201', 'THDC', 1, '2006-05-20', 8.50, 'Dat'),
('K1201', 'CTRR', 1, '2006-05-13', 9.00, 'Dat'),
('K1202', 'CSDL', 1, '2006-07-20', 8.00, 'Dat'),
('K1202', 'CTDLGT', 1, '2006-12-28', 4.00, 'Khong Dat'),
('K1202', 'CTDLGT', 2, '2007-01-05', 5.00, 'Dat'),
('K1202', 'THDC', 1, '2006-05-20', 4.00, 'Khong Dat'),
('K1202', 'THDC', 2, '2006-05-27', 4.00, 'Khong Dat'),
('K1202', 'CTRR', 1, '2006-05-13', 3.00, 'Khong Dat'),
('K1202', 'CTRR', 2, '2006-05-20', 4.00, 'Khong Dat'),
('K1202', 'CTRR', 3, '2006-06-30', 6.25, 'Dat'),
('K1203', 'CSDL', 1, '2006-07-20', 9.25, 'Dat'),
('K1203', 'CTDLGT', 1, '2006-12-28', 9.50, 'Dat'),
('K1203', 'THDC', 1, '2006-05-20', 10.00, 'Dat'),
('K1203', 'CTRR', 1, '2006-05-13', 10.00, 'Dat'),
('K1204', 'CSDL', 1, '2006-07-20', 8.50, 'Dat'),
('K1204', 'CTDLGT', 1, '2006-12-28', 6.75, 'Dat'),
('K1204', 'THDC', 1, '2006-05-20', 4.00, 'Khong Dat'),
('K1204', 'CTRR', 1, '2006-05-13', 6.00, 'Dat'),
('K1301', 'CSDL', 1, '2006-12-20', 4.25, 'Khong Dat'),
('K1301', 'CTDLGT', 1, '2006-07-25', 8.00, 'Dat'),
('K1301', 'THDC', 1, '2006-05-20', 7.75, 'Dat'),
('K1301', 'CTRR', 1, '2006-05-13', 8.00, 'Dat'),
('K1302', 'CSDL', 1, '2006-12-20', 6.75, 'Dat'),
('K1302', 'CTDLGT', 1, '2006-07-25', 5.00, 'Dat'),
('K1302', 'THDC', 1, '2006-05-20', 8.00, 'Dat'),
('K1302', 'CTRR', 1, '2006-05-13', 8.50, 'Dat'),
('K1303', 'CSDL', 1, '2006-12-20', 4.00, 'Khong Dat'),
('K1303', 'CTDLGT', 1, '2006-07-25', 4.50, 'Khong Dat'),
('K1303', 'CTDLGT', 2, '2006-08-07', 4.00, 'Khong Dat'),
('K1303', 'CTDLGT', 3, '2006-08-15', 4.25, 'Khong Dat'),
('K1303', 'THDC', 1, '2006-05-20', 4.50, 'Khong Dat'),
('K1303', 'CTRR', 1, '2006-05-13', 3.25, 'Khong Dat'),
('K1303', 'CTRR', 2, '2006-05-20', 5.00, 'Dat'),
('K1304', 'CSDL', 1, '2006-12-20', 7.75, 'Dat'),
('K1304', 'CTDLGT', 1, '2006-07-25', 9.75, 'Dat'),
('K1304', 'THDC', 1, '2006-05-20', 5.50, 'Dat'),
('K1304', 'CTRR', 1, '2006-05-13', 5.00, 'Dat'),
('K1305', 'CSDL', 1, '2006-12-20', 9.25, 'Dat'),
('K1305', 'CTDLGT', 1, '2006-07-25', 10.00, 'Dat'),
('K1305', 'THDC', 1, '2006-05-20', 8.00, 'Dat'),
('K1305', 'CTRR', 1, '2006-05-13', 10.00, 'Dat');

INSERT INTO MONHOC (MAMH, TENMH, TCLT, TCTH, MAKHOA) VALUES
('THDC', 'Tin hoc dai cuong', 4, 1, 'KHMT'),
('CTRR', 'Cau truc roi rac', 5, 0, 'KHMT'),
('CSDL', 'Co so du lieu', 3, 1, 'HTTT'),
('CTDLGT', 'Cau truc du lieu va giai thuat', 3, 1, 'KHMT'),
('PTTKTT', 'Phan tich thiet ke thuat toan', 3, 0, 'KHMT'),
('DHMT', 'Do hoa may tinh', 3, 1, 'KHMT'),
('KTMT', 'Kien truc may tinh', 3, 0, 'KTMT'),
('TKCSDL', 'Thiet ke co so du lieu', 3, 1, 'HTTT'),
('PTTKHTTT', 'Phan tich thiet ke he thong thong tin', 4, 1, 'HTTT'),
('HDH', 'He dieu hanh', 4, 0, 'KTMT'),
('NMCNPM', 'Nhap mon cong nghe phan mem', 3, 0, 'CNPM'),
('LTCFW', 'Lap trinh C for win', 3, 1, 'CNPM'),
('LTHDT', 'Lap trinh huong doi tuong', 3, 1, 'CNPM');

INSERT INTO DIEUKIEN (MAMH, MAMH_TRUOC) VALUES
('CSDL', 'CTRR'),
('CSDL', 'CTDLGT'),
('CTDLGT', 'THDC'),
('PTTKTT', 'THDC'),
('PTTKTT', 'CTDLGT'),
('DHMT', 'THDC'),
('LTHDT', 'THDC'),
('PTTKHTTT', 'CSDL');

--CAU I.1
ALTER TABLE HOCVIEN ADD
GHICHU varchar(40),
DIEMTB numeric(4,2),
XEPLOAI varchar(9)

--CAU I.2
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_MAHV CHECK (LEFT(MAHV,3) IN ('K11','K12','K13') AND RIGHT(MAHV,2) LIKE '[0,9],[0,9]')

--CAU I.3
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_GIOITINH CHECK (GIOITINH IN ('NAM','NU'))

--CAU I.4
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_DIEM CHECK (ROUND(DIEM,2) BETWEEN 0 AND 10)

--CAU I.5
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_KQUA CHECK(KETQUA = IIF(DIEM BETWEEN 5 AND 10,'Dat','Khong Dat'))

--CAU I.6
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_LANTHI CHECK (LANTHI BETWEEN 0 AND 3)

--CAU I.7
ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_HOCKY CHECK (HOCKY BETWEEN 1 AND 3)

--CAU I.8
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_HOCVI CHECK (HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'PTS'))

--CAU I.11
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_HV_TUOI CHECK(YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

--CAU I.12
ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_GD_NGAY CHECK(TUNGAY < DENNGAY)

--CAU I.13
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_GV_NGVL CHECK(YEAR(NGVL) - YEAR(NGSINH) >= 22)

--CAU I.14
ALTER TABLE MONHOC
ADD CONSTRAINT CK_MH_LTTT CHECK(ABS(TCLT - TCTH) <= 3)

--CAU III.1
SELECT MAHV, HO, TEN, NGSINH, LOP.MALOP 
FROM LOP 
	INNER JOIN HOCVIEN ON LOP.TRGLOP = HOCVIEN.MAHV

--CAU III.2
SELECT HOCVIEN.MAHV, HO, TEN ,LANTHI, DIEM FROM LOP 
	INNER JOIN HOCVIEN ON LOP.MALOP = HOCVIEN.MALOP
	INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE (LEFT(LOP.MALOP,3) = 'K12') AND (MAMH = 'CTRR') 
ORDER BY TEN ASC

--CAU III.3
SELECT HOCVIEN.MAHV, HO, TEN, MAMH FROM HOCVIEN
	INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE LANTHI = 1 AND KQUA = 'Dat'

--CAU III.4
SELECT HOCVIEN.MAHV, HO, TEN FROM HOCVIEN	
	INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE (MAMH = 'CTRR') AND (LEFT(MALOP,3) = 'K11') AND (LANTHI = 1) AND (KQUA = 'Khong Dat')

--CAU III.5
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN FROM HOCVIEN 
	INNER JOIN KETQUATHI ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE (LEFT(MALOP,1) = 'K') AND (MAMH = 'CTRR') AND (KQUA = 'Khong Dat')
 
--CAU II.1
UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT MAGV FROM GIAOVIEN
					INNER JOIN KHOA ON KHOA.TRGKHOA = GIAOVIEN.MAGV)

--CAU II.2
UPDATE HOCVIEN
SET DIEMTB = (SELECT AVG(DIEM) FROM KETQUATHI
			  WHERE LANTHI = (SELECT MAX(LANTHI) FROM KETQUATHI
							  WHERE MAHV = KETQUATHI.MAHV 
							  GROUP BY MAHV)
			  GROUP BY MAHV
			  HAVING MAHV = HOCVIEN.MAHV)

--CAU II.3
UPDATE HOCVIEN
SET GHICHU = 'Cam thi'
WHERE MAHV IN (SELECT MAHV FROM KETQUATHI
			   WHERE LANTHI = 3 AND DIEM < 5)

--CAU II.4
UPDATE HOCVIEN
SET XEPLOAI = (CASE 
					WHEN DIEMTB >= 9 THEN 'XS'
					WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
					WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
					WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
					WHEN DIEMTB < 5 THEN 'Y'
			   END)

--CAU III.6
SELECT DISTINCT MONHOC.TENMH FROM MONHOC
	INNER JOIN GIANGDAY ON GIANGDAY.MAMH = MONHOC.MAMH
	INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE HOTEN = 'Tran Tam Thanh' AND HOCKY = 1 AND NAM = 2006

--CAU III.7
SELECT MONHOC.MAMH, TENMH FROM MONHOC
	INNER JOIN GIANGDAY ON GIANGDAY.MAMH = MONHOC.MAMH
	INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
	INNER JOIN LOP ON LOP.MAGVCN = GIAOVIEN.MAGV
WHERE LOP.MALOP = 'K11' AND HOCKY = 1 AND NAM = 2006

--CAU III.8
SELECT HO, TEN FROM HOCVIEN
	INNER JOIN LOP ON LOP.TRGLOP = HOCVIEN.MAHV
	INNER JOIN GIANGDAY ON GIANGDAY.MALOP = LOP.MALOP
	INNER JOIN GIAOVIEN ON GIAOVIEN.MAGV = GIANGDAY.MAGV
	INNER JOIN MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH
WHERE HOTEN = 'Nguyen To Lan' AND TENMH = 'Co So Du Lieu'

--CAU III.9
SELECT MONHOC.MAMH, TENMH FROM MONHOC
	INNER JOIN DIEUKIEN ON DIEUKIEN.MAMH_TRUOC = MONHOC.MAMH
WHERE DIEUKIEN.MAMH = 'CSDL'

--CAU III.10
SELECT MONHOC.MAMH, TENMH FROM MONHOC 
	INNER JOIN DIEUKIEN ON DIEUKIEN.MAMH = MONHOC.MAMH
WHERE DIEUKIEN.MAMH_TRUOC = 'CTRR'

--CAU III.11
SELECT HOTEN FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV
WHERE MALOP = 'K11' AND HOCKY = 1 AND NAM = 2006 AND MAMH = 'CTRR'
UNION
SELECT HOTEN FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV
WHERE MALOP = 'K12' AND HOCKY = 1 AND NAM = 2006 AND MAMH = 'CTRR'

--CAU III.12
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN FROM HOCVIEN
	INNER JOIN KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE LANTHI = 1 AND MAMH = 'CSDL' AND KQUA = 'Khong Dat' AND NOT EXISTS(SELECT * FROM KETQUATHI
																		 WHERE LANTHI > 1 AND MAMH = 'CSDL' AND KETQUATHI.MAHV = HOCVIEN.MAHV)

--CAU III.13
SELECT GIAOVIEN.MAGV, HOTEN FROM GIAOVIEN
EXCEPT
SELECT GIAOVIEN.MAGV, HOTEN FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV

--CAU III.14
SELECT GIAOVIEN.MAGV, HOTEN FROM GIAOVIEN
EXCEPT
SELECT GIAOVIEN.MAGV, HOTEN FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIANGDAY.MAGV = GIAOVIEN.MAGV
	INNER JOIN MONHOC ON MONHOC.MAMH = GIANGDAY.MAMH
WHERE GIAOVIEN.MAKHOA = MONHOC.MAKHOA

--CAU III.15
SELECT HO, TEN FROM HOCVIEN 
	INNER JOIN KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
WHERE (MALOP = 'K11') AND ((LANTHI = 3 AND KQUA = 'Khong Dat') OR (MAMH = 'CTRR' AND LANTHI = 2 AND DIEM = 5))

--CAU III.16
SELECT GIAOVIEN.MAGV, HOTEN FROM GIAOVIEN
	INNER JOIN GIANGDAY ON GIAOVIEN.MAGV = GIANGDAY.MAGV
WHERE MAMH = 'CTRR'
GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY
HAVING count(*) >= 2

--CAU III.17
SELECT HOCVIEN.*, DIEM FROM KETQUATHI
	INNER JOIN HOCVIEN ON HOCVIEN.MAHV = KETQUATHI.MAHV
WHERE MAMH = 'CSDL' AND LANTHI = (SELECT max(LANTHI) FROM KETQUATHI 
								  WHERE MAMH = 'CSDL' AND KETQUATHI.MAHV = HOCVIEN.MAHV 
								  GROUP BY MAHV)

--CAU III.18
SELECT HOCVIEN.*, DIEM FROM HOCVIEN
	INNER JOIN KETQUATHI ON KETQUATHI.MAHV = HOCVIEN.MAHV
	INNER JOIN MONHOC ON MONHOC.MAMH = KETQUATHI.MAMH
WHERE TENMH = 'Co So Du Lieu' AND Diem = (SELECT MAX(Diem) FROM KetQuaThi, MonHoc
										  WHERE KetQuaThi.MaMH = MonHoc.MaMH AND MaHV = HocVien.MaHV AND TenMH = 'Co So Du Lieu'
										  GROUP BY MaHV)

--CAU III.19
SELECT MAKHOA, TENKHOA 
FROM KHOA
WHERE NGTLAP = (SELECT MIN(NGTLAP) 
			    FROM KHOA)

--CAU III.20
SELECT COUNT(*) AS SOGIAOVIEN
FROM GIAOVIEN
WHERE HOCHAM IN ('GS', 'PGS')

-- CAU III.21 
SELECT MAKHOA, HOCVI, COUNT(*) AS SOGIAOVIEN
FROM GIAOVIEN
GROUP BY MAKHOA, HOCVI
ORDER BY MAKHOA

-- CAU III.22  
SELECT MAMH, KQUA, COUNT(*) AS SOGIAOVIEN
FROM KETQUATHI
GROUP BY MAMH, KQUA
ORDER BY MAMH

-- CAU III.23  
SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN, LOP, GIANGDAY
WHERE GIANGDAY.MALOP = LOP.MALOP
AND GIANGDAY.MAGV = GIAOVIEN.MAGV
AND GIAOVIEN.MAGV = LOP.MAGVCN

-- CAU III.24 
SELECT HO, TEN
FROM HOCVIEN, LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP
AND LOP.SISO = (SELECT MAX(SISO) 
				FROM LOP)

-- CAU III.25 
SELECT HO, TEN
FROM HOCVIEN, LOP, KETQUATHI
WHERE HOCVIEN.MAHV = LOP.TRGLOP
AND HOCVIEN.MAHV = KETQUATHI.MAHV
AND KQUA = 'Khong Dat'
GROUP BY TRGLOP, HO, TEN
HAVING COUNT(*) > 3

-- CAU III.26 
SELECT TOP 1 WITH TIES HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
AND DIEM >= 9
GROUP BY HOCVIEN.MAHV, HO, TEN
ORDER BY COUNT(*) DESC

-- CAU III.27 
SELECT MALOP, MAHV, HO, TEN
FROM(SELECT MALOP, HOCVIEN.MAHV, HO, TEN, COUNT(*) SOLUONGDIEM, RANK() OVER (PARTITION BY MALOP ORDER BY COUNT(*) DESC) AS XEPHANG
	 FROM HOCVIEN, KETQUATHI
	 WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
	 AND DIEM >= 9
	 GROUP BY MALOP, HOCVIEN.MAHV, HO, TEN) AS A
WHERE A.XEPHANG = 1

-- CAU III.28 
SELECT MAGV, COUNT(DISTINCT MAMH) AS SOMONHOC, COUNT(DISTINCT MALOP) AS SOLOP
FROM GIANGDAY
GROUP BY MAGV

-- CAU III.29 
SELECT HOCKY, NAM, A.MAGV, HOTEN
FROM GIAOVIEN, (SELECT HOCKY, NAM, MAGV, RANK() OVER (PARTITION BY HOCKY, NAM ORDER BY COUNT(*) DESC) AS XEPHANG
				FROM GIANGDAY
				GROUP BY HOCKY, NAM, MAGV) AS A
WHERE A.MAGV = GIAOVIEN.MAGV
AND XEPHANG = 1
ORDER BY NAM, HOCKY

-- CAU III.30 
SELECT TOP 1 WITH TIES MONHOC.MAMH, TENMH
FROM MONHOC, KETQUATHI
WHERE MONHOC.MAMH = KETQUATHI.MAMH
AND LANTHI = 1
AND KQUA = 'Khong Dat'
GROUP BY MONHOC.MAMH, TENMH
ORDER BY COUNT(*) DESC

-- CAU III.31 
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
AND NOT EXISTS(SELECT *
			   FROM KETQUATHI
			   WHERE LANTHI = 1
			   AND KQUA = 'Khong Dat'
			   AND MAHV = HOCVIEN.MAHV)

-- CAU III.32 
SELECT DISTINCT HOCVIEN.MAHV, HO, TEN
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
AND NOT EXISTS(SELECT *
			   FROM KETQUATHI
			   WHERE LANTHI = (SELECT MAX(LANTHI) 
							   FROM KETQUATHI 
							   WHERE MAHV = HOCVIEN.MAHV 
							   GROUP BY MAHV)
			   AND KQUA = 'Khong Dat'
			   AND MAHV = HOCVIEN.MAHV)

-- CAU III.33 
SELECT MAHV, HO, TEN
FROM HOCVIEN
WHERE NOT EXISTS(SELECT *
				 FROM MONHOC
				 WHERE NOT EXISTS(SELECT *
								  FROM KETQUATHI
								  WHERE KETQUATHI.MAMH = MONHOC.MAMH
								  AND KETQUATHI.MAHV = HOCVIEN.MAHV
								  AND LANTHI = 1 
								  AND KQUA = 'Dat'))

-- CAU III.35
SELECT MAMH, MAHV, HOTEN
FROM (SELECT MAMH, HOCVIEN.MAHV, (HO+' '+TEN) HOTEN, RANK() OVER (PARTITION BY MAMH ORDER BY MAX(DIEM) DESC) AS XEPHANG
	  FROM HOCVIEN, KETQUATHI
	  WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
	  AND LANTHI = (SELECT MAX(LANTHI) 
					FROM KETQUATHI 
					WHERE MAHV = HOCVIEN.MAHV 
					GROUP BY MAHV)
	  GROUP BY MAMH, HOCVIEN.MAHV, HO, TEN) AS A
WHERE XEPHANG = 1